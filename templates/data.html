{% extends "base.html" %}
{% block title %}数据表 - 期货日K线数据系统{% endblock %}
{% block head %}
  <style>
    .toolbar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    .toolbar select { padding: 8px 12px; font-size: 14px; border-radius: 8px; border: 1px solid #334155; background: #16213e; color: #e4e4e7; cursor: pointer; min-width: 120px; }
    .table-wrap { overflow: auto; border: 1px solid #2d3748; border-radius: 8px; background: #16213e; max-height: 70vh; }
    .table-wrap table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table-wrap th, .table-wrap td { padding: 8px 12px; text-align: right; border-bottom: 1px solid #2d3748; }
    .table-wrap th { text-align: left; position: sticky; top: 0; background: #16213e; color: #94a3b8; z-index: 1; }
    .table-wrap tr:hover { background: rgba(38,166,154,0.08); }
    .pager { margin-top: 12px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; color: #94a3b8; font-size: 14px; }
    .pager button { padding: 6px 14px; border-radius: 6px; border: 1px solid #334155; background: #16213e; color: #e4e4e7; cursor: pointer; }
    .pager button:hover { background: #1e293b; }
    .pager button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pager-jump { display: flex; align-items: center; gap: 6px; }
    .pager-jump input { width: 56px; padding: 6px 8px; border-radius: 6px; border: 1px solid #334155; background: #16213e; color: #e4e4e7; font-size: 14px; text-align: center; }
    .pager-jump input:focus { outline: none; border-color: #26a69a; }
    .empty-tip { padding: 32px; text-align: center; color: #64748b; }
    .toolbar input[type="date"] { padding: 6px 10px; font-size: 14px; border-radius: 8px; border: 1px solid #334155; background: #16213e; color: #e4e4e7; }
    .toolbar input[type="date"]:focus { outline: none; border-color: #26a69a; }
  </style>
{% endblock %}
{% block content %}
  <h1 style="margin-top:0; font-size:1.4rem;">数据表</h1>
  <div class="toolbar">
    <label for="symbol" style="color:#94a3b8;">品种：</label>
    <select id="symbol">
      {% for code, name in symbols %}
      <option value="{{ code }}">{{ name }}</option>
      {% endfor %}
    </select>
    <label for="sizeSel" style="color:#94a3b8; margin-left:12px;">每页：</label>
    <select id="sizeSel">
      <option value="50">50</option>
      <option value="100" selected>100</option>
      <option value="200">200</option>
      <option value="500">500</option>
    </select>
    <span style="margin-left:12px; color:#94a3b8; font-size:14px;">在 K 线图查看：</span>
    <label for="klineStart" style="color:#94a3b8;">从</label>
    <input type="date" id="klineStart" title="开始日期（可选）" />
    <label for="klineEnd" style="color:#94a3b8;">至</label>
    <input type="date" id="klineEnd" title="结束日期（可选）" />
    <a href="#" id="linkKline" style="margin-left:8px; color:#26a69a; font-size:14px;">跳转</a>
  </div>
  <div class="table-wrap">
    <table>
      <thead><tr><th>日期</th><th>开盘(元/吨)</th><th>最高(元/吨)</th><th>最低(元/吨)</th><th>收盘(元/吨)</th><th>成交量(手)</th><th>MA20</th></tr></thead>
      <tbody id="tb"></tbody>
    </table>
    <div id="emptyTip" class="empty-tip" style="display:none;">请选择品种</div>
    <div id="loadingTip" class="empty-tip" style="display:none; color:#26a69a;">加载中…</div>
  </div>
  <div class="pager" id="pager" style="display:none;">
    <span id="info"></span>
    <button id="prev">上一页</button>
    <button id="next">下一页</button>
    <div class="pager-jump">
      <span style="color:#94a3b8;">跳至</span>
      <input type="number" id="pageInput" min="1" placeholder="页码" title="输入页码后回车或点击跳转" />
      <span id="totalPagesSpan">/ 1</span>
      <button id="gotoBtn">跳转</button>
    </div>
  </div>
{% endblock %}
{% block script %}
<script>
(function() {
  var symbolSel = document.getElementById("symbol");
  var tb = document.getElementById("tb");
  var emptyTip = document.getElementById("emptyTip");
  var pager = document.getElementById("pager");
  var info = document.getElementById("info");
  var prevBtn = document.getElementById("prev");
  var nextBtn = document.getElementById("next");
  var pageInput = document.getElementById("pageInput");
  var gotoBtn = document.getElementById("gotoBtn");
  var totalPagesSpan = document.getElementById("totalPagesSpan");
  var sizeSel = document.getElementById("sizeSel");
  var loadingTip = document.getElementById("loadingTip");

  var page = 1, size = 100, total = 0;

  function load() {
    emptyTip.style.display = "none";
    loadingTip.style.display = "block";
    var code = symbolSel.value;
    fetch("/api/table/" + encodeURIComponent(code) + "?page=" + page + "&size=" + size)
      .then(function(r) {
        return r.json().then(function(data) {
          if (!r.ok) throw new Error((data && (data.error || data.log)) || "无数据");
          return data;
        }).catch(function() { throw new Error("无数据"); });
      })
      .then(function(data) {
        loadingTip.style.display = "none";
        total = data.total;
        var rows = data.rows || [];
        if (rows.length === 0) {
          tb.innerHTML = ""; emptyTip.style.display = "block"; emptyTip.textContent = "该品种暂无数据";
          pager.style.display = "none";
          return;
        }
        pager.style.display = "flex";
        var html = "";
        rows.forEach(function(r) {
          html += "<tr><td>" + r[0] + "</td><td>" + r[1] + "</td><td>" + r[2] + "</td><td>" + r[3] + "</td><td>" + r[4] + "</td><td>" + r[5] + "</td><td>" + (r[6] !== "" ? r[6] : "") + "</td></tr>";
        });
        tb.innerHTML = html;
        var from = (data.page - 1) * data.size + 1;
        var to = Math.min(data.page * data.size, data.total);
        info.textContent = "共 " + data.total + " 条，当前 " + from + "–" + to;
        prevBtn.disabled = data.page <= 1;
        nextBtn.disabled = data.page * data.size >= data.total;
        var maxPage = Math.ceil(data.total / data.size) || 1;
        totalPagesSpan.textContent = "/ " + maxPage;
        pageInput.max = maxPage;
        pageInput.value = data.page;
      })
      .catch(function() {
        loadingTip.style.display = "none";
        tb.innerHTML = ""; emptyTip.style.display = "block"; emptyTip.textContent = "加载失败，请刷新重试";
        pager.style.display = "none";
      });
  }

  function gotoPage() {
    var p = parseInt(pageInput.value, 10);
    var maxPage = Math.ceil(total / size) || 1;
    if (p >= 1 && p <= maxPage) { page = p; load(); }
  }

  var linkKline = document.getElementById("linkKline");
  var klineStart = document.getElementById("klineStart");
  var klineEnd = document.getElementById("klineEnd");
  function buildKlineUrl() {
    var url = "/kline?code=" + encodeURIComponent(symbolSel.value);
    if (klineStart.value) url += "&start=" + encodeURIComponent(klineStart.value);
    if (klineEnd.value) url += "&end=" + encodeURIComponent(klineEnd.value);
    return url;
  }
  linkKline.href = buildKlineUrl();
  symbolSel.addEventListener("change", function() { page = 1; load(); linkKline.href = buildKlineUrl(); });
  klineStart.addEventListener("change", function() { linkKline.href = buildKlineUrl(); });
  klineEnd.addEventListener("change", function() { linkKline.href = buildKlineUrl(); });
  sizeSel.addEventListener("change", function() { size = parseInt(sizeSel.value, 10); page = 1; load(); });
  prevBtn.addEventListener("click", function() { if (page > 1) { page--; load(); } });
  nextBtn.addEventListener("click", function() { if (page * size < total) { page++; load(); } });
  gotoBtn.addEventListener("click", gotoPage);
  pageInput.addEventListener("keydown", function(e) { if (e.key === "Enter") { e.preventDefault(); gotoPage(); } });
  load();
})();
</script>
{% endblock %}
