{% extends "base.html" %}
{% block title %}K线图 - 期货日K线数据系统{% endblock %}
{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    .toolbar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    .toolbar label { font-size: 14px; color: #94a3b8; }
    .toolbar select { padding: 8px 12px; font-size: 14px; border-radius: 8px; border: 1px solid #334155; background: #16213e; color: #e4e4e7; cursor: pointer; min-width: 120px; }
    #chart { width: 100%; height: 55vh; min-height: 360px; transform: translateZ(0); will-change: transform; }
    .table-wrap { margin-top: 16px; max-height: 38vh; overflow: auto; border: 1px solid #2d3748; border-radius: 8px; background: #16213e; }
    .table-wrap table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table-wrap th, .table-wrap td { padding: 8px 12px; text-align: right; border-bottom: 1px solid #2d3748; }
    .table-wrap th { text-align: left; position: sticky; top: 0; background: #16213e; color: #94a3b8; }
    .table-wrap tr:hover { background: rgba(38,166,154,0.08); }
    .table-wrap tr.row-highlight { background: rgba(38,166,154,0.22); }
    .table-wrap tr { cursor: pointer; }
    .empty-tip { color: #64748b; padding: 24px; text-align: center; }
    .range-bar { display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .range-bar span { font-size: 13px; color: #64748b; margin-right: 4px; }
    .range-bar .btn { padding: 6px 14px; font-size: 13px; border-radius: 8px; border: 1px solid transparent; background: transparent; color: #64748b; cursor: pointer; font-weight: normal; }
    .range-bar .btn:hover { color: #ef5350; }
    .range-bar .btn.active { font-weight: bold; color: #ef5350; border-color: #cbd5e1; background: rgba(239,83,80,0.06); }
    .theme-dark .range-bar .btn.active { border-color: #475569; background: rgba(239,83,80,0.08); }
  </style>
{% endblock %}
{% block content %}
  <h1 style="margin-top:0; font-size:1.4rem;">K线图</h1>
  <div class="toolbar">
    <label for="symbol">品种：</label>
    <select id="symbol">
      {% for code, name in symbols %}
      <option value="{{ code }}">{{ name }}</option>
      {% endfor %}
    </select>
    <span style="color:#64748b; font-size:13px;">在图表上拖拽平移、滚轮缩放；点击表格行或折线定位</span>
  </div>
  <div class="range-bar" id="rangeBar">
    <span>区间：</span>
    <button type="button" class="btn" data-range="1m">1月</button>
    <button type="button" class="btn" data-range="3m">3月</button>
    <button type="button" class="btn" data-range="6m">6月</button>
    <button type="button" class="btn" data-range="1y">1年</button>
    <button type="button" class="btn" data-range="5y">5年</button>
    <button type="button" class="btn" data-range="all">全部</button>
  </div>
  <div id="chart"></div>
  <div class="table-wrap">
    <table>
      <thead><tr><th>日期</th><th>开盘</th><th>最高</th><th>最低</th><th>收盘</th><th>成交量</th><th>MA20</th></tr></thead>
      <tbody id="tb"></tbody>
    </table>
    <div id="emptyTip" class="empty-tip" style="display:none;">请选择品种或等待数据加载</div>
  </div>
{% endblock %}
{% block script %}
<script>
(function() {
  var symbolSel = document.getElementById("symbol");
  var chartDom = document.getElementById("chart");
  var tb = document.getElementById("tb");
  var emptyTip = document.getElementById("emptyTip");
  var body = document.getElementById("body-theme");

  function isDark() { return body.classList.contains("theme-dark"); }
  function chartTheme() {
    var dark = isDark();
    return {
      backgroundColor: "transparent",
      textStyle: { color: dark ? "#94a3b8" : "#64748b" },
      legend: { textStyle: { color: dark ? "#94a3b8" : "#64748b" } },
      grid: [ {} ],
      xAxis: [ { axisLabel: { color: dark ? "#94a3b8" : "#64748b" }, splitLine: { show: true, lineStyle: { opacity: dark ? 0.16 : 0.12, color: dark ? "#334155" : "#e2e8f0" } } } ],
      yAxis: [ { axisLabel: { color: dark ? "#94a3b8" : "#64748b" }, splitLine: { show: true, lineStyle: { opacity: dark ? 0.25 : 0.2, color: dark ? "#334155" : "#e2e8f0" } } } ],
      dataZoom: [
        { textStyle: { color: dark ? "#94a3b8" : "#64748b" }, borderColor: dark ? "#475569" : "#cbd5e1", fillerColor: dark ? "rgba(71,85,105,0.2)" : "rgba(148,163,184,0.15)", handleStyle: { color: dark ? "#64748b" : "#94a3b8" }, moveHandleStyle: { color: dark ? "#64748b" : "#94a3b8" } },
        { textStyle: { color: dark ? "#94a3b8" : "#64748b" }, borderColor: dark ? "#475569" : "#cbd5e1", fillerColor: dark ? "rgba(71,85,105,0.2)" : "rgba(148,163,184,0.15)", handleStyle: { color: dark ? "#64748b" : "#94a3b8" }, moveHandleStyle: { color: dark ? "#64748b" : "#94a3b8" } }
      ]
    };
  }

  var chart = echarts.init(chartDom, null, { renderer: "canvas", useDirtyRect: true });
  var cache = {};
  var tableDebounceTimer = null;
  var currentData = null;

  function loadData(code, cb) {
    if (cache[code]) { cb(cache[code]); return; }
    fetch("/api/kline/" + encodeURIComponent(code)).then(function(r) {
      if (!r.ok) throw new Error("无数据");
      return r.json();
    }).then(function(data) {
      cache[code] = data;
      cb(data);
    }).catch(function(e) {
      cb(null);
    });
  }

  function fillTable(data, i0, i1) {
    if (!data || !data.dates) { tb.innerHTML = ""; emptyTip.style.display = "block"; return; }
    emptyTip.style.display = "none";
    var dates = data.dates, k = data.k, vol = data.vol, ma20 = data.ma20 || [];
    i0 = Math.max(0, Math.floor(i0));
    i1 = Math.min(dates.length, Math.ceil(i1));
    var html = "";
    for (var i = i0; i < i1; i++) {
      var r = k[i];
      var m = ma20[i] != null ? ma20[i] : "";
      html += "<tr data-index=\"" + i + "\"><td>" + dates[i] + "</td><td>" + r[0] + "</td><td>" + r[3] + "</td><td>" + r[2] + "</td><td>" + r[1] + "</td><td>" + vol[i] + "</td><td>" + m + "</td></tr>";
    }
    tb.innerHTML = html;
  }

  function zoomToDateRange(data, startDate, endDate) {
    var dates = data.dates;
    if (!dates || dates.length === 0) return;
    var i0 = 0, i1 = dates.length - 1;
    if (startDate) {
      for (var i = 0; i < dates.length; i++) { if (dates[i] >= startDate) { i0 = i; break; } }
    }
    if (endDate) {
      for (var j = dates.length - 1; j >= 0; j--) { if (dates[j] <= endDate) { i1 = j; break; } }
    }
    if (i0 > i1) i1 = i0;
    var len = dates.length;
    var start = (i0 / len) * 100;
    var end = (i1 / len) * 100;
    chart.setOption({ dataZoom: [ { start: start, end: end }, { start: start, end: end } ] });
    fillTable(data, i0, i1 + 1);
  }

  function zoomToRange(data, rangeKey) {
    var len = data.dates.length;
    if (len === 0) return;
    var n = len;
    if (rangeKey === "1m") n = Math.min(22, len);
    else if (rangeKey === "3m") n = Math.min(66, len);
    else if (rangeKey === "6m") n = Math.min(126, len);
    else if (rangeKey === "1y") n = Math.min(252, len);
    else if (rangeKey === "5y") n = Math.min(1260, len);
    var i0 = len - n;
    var start = (i0 / len) * 100;
    var end = 100;
    chart.setOption({ dataZoom: [{ start: start, end: end }, { start: start, end: end }] });
    fillTable(data, i0, len);
  }

  function zoomToIndex(data, idx) {
    var len = data.dates.length;
    if (len === 0) return;
    var half = 25;
    var i0 = Math.max(0, idx - half);
    var i1 = Math.min(len, idx + half);
    var start = (i0 / len) * 100;
    var end = (i1 / len) * 100;
    chart.setOption({ dataZoom: [{ start: start, end: end }, { start: start, end: end }] });
    fillTable(data, i0, i1);
    highlightRow(idx);
    setTimeout(function() { highlightRow(idx); }, 80);
  }

  function highlightRow(idx) {
    var rows = tb.querySelectorAll("tr");
    rows.forEach(function(tr) { tr.classList.remove("row-highlight"); });
    var row = tb.querySelector("tr[data-index=\"" + idx + "\"]");
    if (row) {
      row.classList.add("row-highlight");
      row.scrollIntoView({ block: "nearest", behavior: "smooth" });
    }
  }

  function applyChartOption(baseOpt, data) {
    var dates = data.dates, kData = data.k, ma20 = data.ma20 || [];
    var closeData = kData.map(function(c) { return c[1]; });
    var theme = chartTheme();
    var opt = {
      animation: false,
      animationThreshold: 0,
      large: true,
      largeThreshold: 2000,
      progressive: 800,
      progressiveThreshold: 3000,
      tooltip: { trigger: "axis", axisPointer: { type: "cross" } },
      legend: { data: ["收盘价"], top: 0, textStyle: theme.textStyle },
      grid: [ { left: "10%", right: "8%", top: "14%", bottom: "18%", containLabel: true } ],
      xAxis: [ { type: "category", data: dates, boundaryGap: false, axisLabel: { show: true }, silent: false, splitLine: { show: true } } ],
      yAxis: [ { type: "value", scale: true, splitLine: { show: true }, axisLabel: {} } ],
      dataZoom: [
        { type: "inside", xAxisIndex: [0], start: 70, end: 100, throttleDelay: 80, filterMode: "none", zoomOnMouseWheel: true, moveOnMouseMove: true },
        { type: "slider", xAxisIndex: [0], start: 70, end: 100, throttleDelay: 80, filterMode: "none", showDataShadow: false, showDetail: false, height: 24, borderColor: "transparent", fillerColor: isDark() ? "rgba(71,85,105,0.25)" : "rgba(148,163,184,0.2)", handleSize: "60%", moveHandleSize: "60%" }
      ],
      series: [{
        name: "收盘价",
        type: "line",
        data: closeData,
        symbol: "circle",
        symbolSize: function(v, idx) { return idx === closeData.length - 1 ? 6 : 0; },
        showSymbol: true,
        smooth: true,
        lineStyle: { color: "#ef5350", width: 2 },
        itemStyle: { color: "#ef5350" },
        areaStyle: { color: "rgba(239,83,80,0.18)" },
        sampling: "lttb",
        progressive: 500
      }]
    };
    opt.legend.textStyle = theme.legend.textStyle;
    opt.xAxis[0].axisLabel.color = theme.xAxis[0].axisLabel.color;
    opt.xAxis[0].splitLine = theme.xAxis[0].splitLine;
    opt.yAxis[0].axisLabel = theme.yAxis[0].axisLabel;
    opt.yAxis[0].splitLine = theme.yAxis[0].splitLine;
    opt.dataZoom[0] = Object.assign(opt.dataZoom[0], theme.dataZoom[0]);
    opt.dataZoom[1] = Object.assign(opt.dataZoom[1], theme.dataZoom[1]);
    chart.setOption(opt, { replaceMerge: ["series"] });
  }

  function render(code) {
    emptyTip.style.display = "block";
    emptyTip.textContent = "加载中…";
    loadData(code, function(data) {
      if (!data) {
        tb.innerHTML = ""; emptyTip.style.display = "block"; emptyTip.textContent = "该品种暂无数据";
        chart.clear();
        return;
      }
      emptyTip.style.display = "none";
      currentData = data;
      applyChartOption(null, data);
      chart.off("dataZoom");
      chart.on("dataZoom", function() {
        if (tableDebounceTimer) clearTimeout(tableDebounceTimer);
        tableDebounceTimer = setTimeout(function() {
          tableDebounceTimer = null;
          var opt = chart.getOption();
          var dz = opt.dataZoom && (opt.dataZoom[0] || opt.dataZoom[1]);
          if (!dz || dz.start == null) return;
          var len = data.dates.length;
          var start = (dz.start / 100) * len;
          var end = (dz.end / 100) * len;
          fillTable(data, start, end);
        }, 100);
      });
      chart.off("click");
      chart.on("click", function(param) {
        if (param.seriesName === "收盘价" && param.dataIndex != null && currentData) {
          zoomToIndex(currentData, param.dataIndex);
        }
      });
      tb.onclick = function(e) {
        var tr = e.target && e.target.closest("tr[data-index]");
        if (tr && currentData) {
          var idx = parseInt(tr.getAttribute("data-index"), 10);
          zoomToIndex(currentData, idx);
        }
      };
      var params = new URLSearchParams(window.location.search);
      var startParam = params.get("start") || "", endParam = params.get("end") || "";
      var rangeBar = document.getElementById("rangeBar");
      rangeBar.querySelectorAll(".btn").forEach(function(btn) {
        btn.classList.remove("active");
        btn.onclick = function() {
          rangeBar.querySelectorAll(".btn").forEach(function(b) { b.classList.remove("active"); });
          btn.classList.add("active");
          zoomToRange(data, btn.getAttribute("data-range"));
        };
      });
      if (startParam || endParam) {
        zoomToDateRange(data, startParam || null, endParam || null);
      } else {
        zoomToRange(data, "all");
        rangeBar.querySelector(".btn[data-range=\"all\"]").classList.add("active");
      }
    });
  }

  body.addEventListener("themechange", function() {
    var code = symbolSel.value;
    if (!cache[code]) return;
    applyChartOption(null, cache[code]);
  });

  symbolSel.addEventListener("change", function() { render(symbolSel.value); });
  window.addEventListener("resize", function() { chart.resize(); });
  var params = new URLSearchParams(window.location.search);
  var codeFromUrl = params.get("code");
  if (codeFromUrl) {
    var opt = Array.from(symbolSel.options).find(function(o) { return o.value === codeFromUrl; });
    if (opt) symbolSel.value = codeFromUrl;
  }
  render(symbolSel.value);
})();
</script>
{% endblock %}
